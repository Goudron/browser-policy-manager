{% extends "base.html" %}
{% block content %}
<h2>Create profile</h2>

<div style="display:flex;gap:2rem;flex-wrap:wrap;">
  <!-- LEFT: FORM -->
  <form id="newForm" method="post" action="/profiles/new" style="flex:1;min-width:340px;display:grid;gap:.75rem;">
    <label>
      <div>Name</div>
      <input type="text" name="name" required style="width:100%;padding:.4rem;">
    </label>

    <label>
      <div>Description</div>
      <input type="text" name="description" style="width:100%;padding:.4rem;">
    </label>

    <label>
      <div>Firefox schema version</div>
      <select name="schema_version" id="schemaSelect" style="width:100%;padding:.4rem;">
        {% for s in schema_options %}
        <option value="{{ s }}" {% if s==default_schema %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </label>

    <fieldset style="border:1px solid #ddd;padding:.75rem;">
      <legend>Boolean policies</legend>
      <div id="flagsContainer" style="display:grid;gap:.25rem;"></div>
    </fieldset>

    <fieldset style="border:1px solid #ddd;padding:.75rem;">
      <legend>DNS over HTTPS</legend>
      <label style="display:flex;gap:.5rem;align-items:center;">
        <input type="checkbox" name="doh_enabled"> Enable DoH
      </label>
      <label>
        <div>Provider URL</div>
        <input type="text" name="doh_provider_url" placeholder="https://dns.example/cdn..."
          style="width:100%;padding:.4rem;">
      </label>
      <label style="display:flex;gap:.5rem;align-items:center;">
        <input type="checkbox" name="doh_locked"> Locked
      </label>
    </fieldset>

    <label>
      <div>Preferences (JSON object)</div>
      <textarea name="preferences_json" id="preferencesJson" rows="6"
        placeholder='{"browser.startup.page": 3, "privacy.donottrackheader.enabled": true}'
        style="width:100%;font-family:monospace;"></textarea>
    </label>

    <label>
      <div>ExtensionSettings (JSON object)</div>
      <textarea name="extension_settings_json" id="extJson" rows="6"
        placeholder='{"*": {"installation_mode": "blocked"}, "addon@corp": {"installation_mode": "force_installed", "updates": true}}'
        style="width:100%;font-family:monospace;"></textarea>
    </label>

    <label>
      <div>Advanced JSON override (merged on top of policies)</div>
      <textarea name="advanced_json" id="advJson" rows="6"
        placeholder='{"Certificates": {"Install": ["/path/rootCA.cer"]}}'
        style="width:100%;font-family:monospace;"></textarea>
    </label>

    <!-- hidden JSON with selected boolean flags -->
    <input type="hidden" name="flags_json" id="flagsJson" value="{}" />

    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
      <button type="submit" class="button is-link">Create</button>
      <a href="/profiles" class="button">Cancel</a>
    </div>
  </form>

  <!-- RIGHT: PREVIEW -->
  <div style="flex:1;min-width:340px;">
    <h3>Live preview (policies.json)</h3>
    <pre id="jsonPreview"
      style="background:#f6f8fa;border:1px solid #ddd;padding:1rem;overflow:auto;min-height:420px;font-size:.9rem;"></pre>
  </div>
</div>

<script>
  const state = {
    name: "",
    description: "",
    schema_version: "{{ default_schema }}",
    flags: {},
    doh: { Enabled: false, ProviderURL: "", Locked: false },
    preferences_json: "",
    extension_settings_json: "",
    advanced_json: ""
  };

  function updateHidden() {
    document.getElementById('flagsJson').value = JSON.stringify(state.flags || {});
  }

  function safeParse(jsonStr) {
    if (!jsonStr || !jsonStr.trim()) return null;
    try { return JSON.parse(jsonStr); } catch { return null; }
  }

  function buildPoliciesObject() {
    const pol = { ...state.flags };

    // DoH
    const dohOut = {};
    if (state.doh?.Enabled) dohOut.Enabled = true;
    if (state.doh?.ProviderURL && state.doh.ProviderURL.trim()) dohOut.ProviderURL = state.doh.ProviderURL.trim();
    if (state.doh?.Locked) dohOut.Locked = true;
    if (Object.keys(dohOut).length) pol["DNSOverHTTPS"] = dohOut;

    // Preferences
    const prefs = safeParse(state.preferences_json);
    if (prefs && typeof prefs === "object" && !Array.isArray(prefs)) pol["Preferences"] = prefs;

    // ExtensionSettings
    const ext = safeParse(state.extension_settings_json);
    if (ext && typeof ext === "object" && !Array.isArray(ext)) pol["ExtensionSettings"] = ext;

    // Advanced override (merge поверх)
    const adv = safeParse(state.advanced_json);
    if (adv && typeof adv === "object" && !Array.isArray(adv)) Object.assign(pol, adv);

    return pol;
  }

  function buildPayloadPreview() {
    const payload = {
      name: state.name,
      description: state.description,
      schema_version: state.schema_version,
      policies: buildPoliciesObject()
    };
    return JSON.stringify(payload, null, 2);
  }

  function renderPreview() {
    document.getElementById('jsonPreview').textContent = buildPayloadPreview();
  }

  async function loadBooleanFlags(schemaVersion) {
    const res = await fetch(`/api/schemas/${schemaVersion}/booleans`);
    if (!res.ok) return;
    const data = await res.json();
    const keys = data.booleans || [];
    const container = document.getElementById('flagsContainer');
    container.innerHTML = "";

    // сохранение отмеченных при смене схемы, если совпадают имена
    const oldFlags = { ...(state.flags || {}) };
    state.flags = {};

    keys.sort().forEach((key) => {
      const label = document.createElement('label');
      label.style.display = "flex";
      label.style.gap = ".5rem";
      label.style.alignItems = "center";

      const input = document.createElement('input');
      input.type = "checkbox";
      input.checked = !!oldFlags[key];
      input.addEventListener('change', () => {
        state.flags[key] = input.checked;
        updateHidden();
        renderPreview();
      });

      const text = document.createElement('span');
      text.textContent = key;

      label.appendChild(input);
      label.appendChild(text);
      container.appendChild(label);

      state.flags[key] = !!oldFlags[key];
    });

    updateHidden();
    renderPreview();
  }

  function attachFormHandlers() {
    const form = document.getElementById('newForm');

    form.name.addEventListener('input', () => { state.name = form.name.value; renderPreview(); });
    form.description.addEventListener('input', () => { state.description = form.description.value; renderPreview(); });

    const schemaSel = document.getElementById('schemaSelect');
    schemaSel.addEventListener('change', async () => {
      state.schema_version = schemaSel.value;
      await loadBooleanFlags(state.schema_version);
    });

    // DoH
    form.doh_enabled.addEventListener('change', () => { state.doh.Enabled = form.doh_enabled.checked; renderPreview(); });
    form.doh_provider_url.addEventListener('input', () => { state.doh.ProviderURL = form.doh_provider_url.value; renderPreview(); });
    form.doh_locked.addEventListener('change', () => { state.doh.Locked = form.doh_locked.checked; renderPreview(); });

    // JSON areas
    const prefs = document.getElementById('preferencesJson');
    const ext = document.getElementById('extJson');
    const adv = document.getElementById('advJson');

    prefs.addEventListener('input', () => { state.preferences_json = prefs.value; renderPreview(); });
    ext.addEventListener('input', () => { state.extension_settings_json = ext.value; renderPreview(); });
    adv.addEventListener('input', () => { state.advanced_json = adv.value; renderPreview(); });

    // init
    state.schema_version = schemaSel.value;
    state.name = form.name.value || "";
    state.description = form.description.value || "";
    state.doh = { Enabled: form.doh_enabled.checked, ProviderURL: form.doh_provider_url.value, Locked: form.doh_locked.checked };
    state.preferences_json = prefs.value || "";
    state.extension_settings_json = ext.value || "";
    state.advanced_json = adv.value || "";
  }

  document.addEventListener('DOMContentLoaded', async () => {
    attachFormHandlers();
    await loadBooleanFlags(state.schema_version);
    renderPreview();
  });
</script>
{% endblock %}