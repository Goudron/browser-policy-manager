{% extends "base.html" %}
{% block content %}
<h2>Create profile</h2>

<div style="display:flex;gap:2rem;flex-wrap:wrap;">
  <!-- LEFT: FORM -->
  <form id="newForm" method="post" action="/profiles/new" style="flex:1;min-width:340px;display:grid;gap:.75rem;">
    <label>
      <div>Name</div>
      <input type="text" name="name" required style="width:100%;padding:.4rem;">
    </label>

    <label>
      <div>Description</div>
      <input type="text" name="description" style="width:100%;padding:.4rem;">
    </label>

    <label>
      <div>Firefox schema version</div>
      <select name="schema_version" id="schemaSelect" style="width:100%;padding:.4rem;">
        {% for s in schema_options %}
        <option value="{{ s }}" {% if s==default_schema %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </label>

    <fieldset style="border:1px solid #ddd;padding:.75rem;">
      <legend>Boolean policies</legend>
      <div id="flagsContainer" style="display:grid;gap:.25rem;"></div>
    </fieldset>

    <!-- hidden JSON with selected flags -->
    <input type="hidden" name="flags_json" id="flagsJson" value="{}" />

    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
      <button type="submit" class="button is-link">Create</button>
      <a href="/profiles" class="button">Cancel</a>
    </div>
  </form>

  <!-- RIGHT: PREVIEW -->
  <div style="flex:1;min-width:340px;">
    <h3>Live preview (policies.json)</h3>
    <pre id="jsonPreview"
      style="background:#f6f8fa;border:1px solid #ddd;padding:1rem;overflow:auto;min-height:320px;font-size:.9rem;"></pre>
  </div>
</div>

<script>
  const state = {
    name: "",
    description: "",
    schema_version: "{{ default_schema }}",
    flags: {}
  };

  function updateHidden() {
    document.getElementById('flagsJson').value = JSON.stringify(state.flags || {});
  }

  function buildPayloadPreview() {
    const payload = {
      name: state.name,
      description: state.description,
      schema_version: state.schema_version,
      policies: { ...state.flags }
    };
    return JSON.stringify(payload, null, 2);
  }

  function renderPreview() {
    document.getElementById('jsonPreview').textContent = buildPayloadPreview();
  }

  async function loadBooleanFlags(schemaVersion) {
    const res = await fetch(`/api/schemas/${schemaVersion}/booleans`);
    if (!res.ok) return;
    const data = await res.json();
    const keys = data.booleans || [];
    const container = document.getElementById('flagsContainer');
    container.innerHTML = "";

    // сбрасываем флаги, сохраняем отмеченные при смене схемы, если совпадают имена
    const oldFlags = { ...(state.flags || {}) };
    state.flags = {};

    keys.sort().forEach((key) => {
      const id = `flag_${key}`;
      const checked = (key in oldFlags) ? !!oldFlags[key] : false;

      const label = document.createElement('label');
      label.style.display = "flex";
      label.style.gap = ".5rem";
      label.style.alignItems = "center";

      const input = document.createElement('input');
      input.type = "checkbox";
      input.id = id;
      input.checked = checked;
      input.addEventListener('change', () => {
        state.flags[key] = input.checked;
        updateHidden();
        renderPreview();
      });

      const text = document.createElement('span');
      text.textContent = key;

      label.appendChild(input);
      label.appendChild(text);
      container.appendChild(label);

      state.flags[key] = checked;
    });

    updateHidden();
    renderPreview();
  }

  function attachFormHandlers() {
    const form = document.getElementById('newForm');
    const nameInput = form.name;
    const descInput = form.description;
    const schemaSel = document.getElementById('schemaSelect');

    nameInput.addEventListener('input', () => { state.name = nameInput.value; renderPreview(); });
    descInput.addEventListener('input', () => { state.description = descInput.value; renderPreview(); });
    schemaSel.addEventListener('change', async () => {
      state.schema_version = schemaSel.value;
      await loadBooleanFlags(state.schema_version);
    });

    // init state
    state.schema_version = schemaSel.value;
    state.name = nameInput.value || "";
    state.description = descInput.value || "";
  }

  document.addEventListener('DOMContentLoaded', async () => {
    attachFormHandlers();
    await loadBooleanFlags(state.schema_version);
    renderPreview();
  });
</script>
{% endblock %}