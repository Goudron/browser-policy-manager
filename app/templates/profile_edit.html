{% extends "base.html" %}
{% block content %}
<h2>Edit profile</h2>

<div style="display:flex;gap:2rem;flex-wrap:wrap;">
    <!-- LEFT: FORM -->
    <form id="editForm" method="post" action="/profiles/{{ p.id }}/edit"
        style="flex:1;min-width:340px;display:grid;gap:.75rem;">
        <label>
            <div>Name</div>
            <input type="text" name="name" value="{{ p.name }}" required style="width:100%;padding:.4rem;">
        </label>

        <label>
            <div>Description</div>
            <input type="text" name="description" value="{{ p.description or '' }}" style="width:100%;padding:.4rem;">
        </label>

        <label>
            <div>Firefox schema version</div>
            <select name="schema_version" id="schemaSelect" style="width:100%;padding:.4rem;">
                {% for s in schema_options %}
                <option value="{{ s }}" {% if s==p.active_schema_version %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </label>

        <fieldset style="border:1px solid #ddd;padding:.75rem;">
            <legend>Boolean policies</legend>
            <div id="flagsContainer" style="display:grid;gap:.25rem;"></div>
        </fieldset>

        <fieldset style="border:1px solid #ddd;padding:.75rem;">
            <legend>DNS over HTTPS</legend>
            <label style="display:flex;gap:.5rem;align-items:center;">
                <input type="checkbox" name="doh_enabled" {% if doh_enabled %}checked{% endif %}> Enable DoH
            </label>
            <label>
                <div>Provider URL</div>
                <input type="text" name="doh_provider_url" value="{{ doh_provider_url }}"
                    placeholder="https://dns.example/cdn..." style="width:100%;padding:.4rem;">
            </label>
            <label style="display:flex;gap:.5rem;align-items:center;">
                <input type="checkbox" name="doh_locked" {% if doh_locked %}checked{% endif %}> Locked
            </label>
        </fieldset>

        <label>
            <div>Preferences (JSON object)</div>
            <textarea name="preferences_json" id="preferencesJson" rows="6"
                style="width:100%;font-family:monospace;">{{ preferences_json }}</textarea>
        </label>

        <label>
            <div>ExtensionSettings (JSON object)</div>
            <textarea name="extension_settings_json" id="extJson" rows="6"
                style="width:100%;font-family:monospace;">{{ extension_settings_json }}</textarea>
        </label>

        <label>
            <div>Advanced JSON override (merged on top of policies)</div>
            <textarea name="advanced_json" id="advJson" rows="6"
                style="width:100%;font-family:monospace;">{{ advanced_json }}</textarea>
        </label>

        <!-- hidden JSON with selected boolean flags -->
        <input type="hidden" name="flags_json" id="flagsJson" value="{}" />

        <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
            <button type="submit" class="button is-link">Save</button>
            <a href="/profiles/{{ p.id }}" class="button">Cancel</a>
        </div>
    </form>

    <!-- RIGHT: PREVIEW -->
    <div style="flex:1;min-width:340px;">
        <h3>Live preview (policies.json)</h3>
        <pre id="jsonPreview"
            style="background:#f6f8fa;border:1px solid #ddd;padding:1rem;overflow:auto;min-height:420px;font-size:.9rem;"></pre>
    </div>
</div>

<script>
    const initialFlags = {{ flags | tojson | safe }};
    const state = {
        name: "{{ p.name }}",
        description: "{{ p.description or '' }}",
        schema_version: "{{ p.active_schema_version }}",
        flags: initialFlags || {},
        doh: {
            Enabled: {{ 'true' if doh_enabled else 'false' }},
    ProviderURL: { { (doh_provider_url | tojson) if doh_provider_url is not none else '""' } },
    Locked: { { 'true' if doh_locked else 'false' } }
      },
    preferences_json: { { (preferences_json | tojson) if preferences_json is not none else '""' } },
    extension_settings_json: { { (extension_settings_json | tojson) if extension_settings_json is not none else '""' } },
    advanced_json: { { (advanced_json | tojson) if advanced_json is not none else '""' } },
    };

    function updateHidden() {
        document.getElementById('flagsJson').value = JSON.stringify(state.flags || {});
    }

    function safeParse(jsonStr) {
        if (!jsonStr || !jsonStr.trim()) return null;
        try { return JSON.parse(jsonStr); } catch { return null; }
    }

    function buildPoliciesObject() {
        const pol = { ...state.flags };

        const dohOut = {};
        if (state.doh?.Enabled) dohOut.Enabled = true;
        if (state.doh?.ProviderURL && state.doh.ProviderURL.trim()) dohOut.ProviderURL = state.doh.ProviderURL.trim();
        if (state.doh?.Locked) dohOut.Locked = true;
        if (Object.keys(dohOut).length) pol["DNSOverHTTPS"] = dohOut;

        const prefs = safeParse(state.preferences_json);
        if (prefs && typeof prefs === "object" && !Array.isArray(prefs)) pol["Preferences"] = prefs;

        const ext = safeParse(state.extension_settings_json);
        if (ext && typeof ext === "object" && !Array.isArray(ext)) pol["ExtensionSettings"] = ext;

        const adv = safeParse(state.advanced_json);
        if (adv && typeof adv === "object" && !Array.isArray(adv)) Object.assign(pol, adv);

        return pol;
    }

    function buildPayloadPreview() {
        const payload = {
            name: state.name,
            description: state.description,
            schema_version: state.schema_version,
            policies: buildPoliciesObject()
        };
        return JSON.stringify(payload, null, 2);
    }

    function renderPreview() {
        document.getElementById('jsonPreview').textContent = buildPayloadPreview();
    }

    async function loadBooleanFlags(schemaVersion) {
        const res = await fetch(`/api/schemas/${schemaVersion}/booleans`);
        if (!res.ok) return;
        const data = await res.json();
        const keys = data.booleans || [];
        const container = document.getElementById('flagsContainer');
        container.innerHTML = "";

        const oldFlags = { ...(state.flags || {}) };
        state.flags = {};

        keys.sort().forEach((key) => {
            const label = document.createElement('label');
            label.style.display = "flex";
            label.style.gap = ".5rem";
            label.style.alignItems = "center";

            const input = document.createElement('input');
            input.type = "checkbox";
            input.checked = !!oldFlags[key];
            input.addEventListener('change', () => {
                state.flags[key] = input.checked;
                updateHidden();
                renderPreview();
            });

            const text = document.createElement('span');
            text.textContent = key;

            label.appendChild(input);
            label.appendChild(text);
            container.appendChild(label);

            state.flags[key] = !!oldFlags[key];
        });

        updateHidden();
        renderPreview();
    }

    function attachFormHandlers() {
        const form = document.getElementById('editForm');

        form.name.addEventListener('input', () => { state.name = form.name.value; renderPreview(); });
        form.description.addEventListener('input', () => { state.description = form.description.value; renderPreview(); });

        const schemaSel = document.getElementById('schemaSelect');
        schemaSel.addEventListener('change', async () => {
            state.schema_version = schemaSel.value;
            await loadBooleanFlags(state.schema_version);
        });

        form.doh_enabled.addEventListener('change', () => { state.doh.Enabled = form.doh_enabled.checked; renderPreview(); });
        form.doh_provider_url.addEventListener('input', () => { state.doh.ProviderURL = form.doh_provider_url.value; renderPreview(); });
        form.doh_locked.addEventListener('change', () => { state.doh.Locked = form.doh_locked.checked; renderPreview(); });

        const prefs = document.getElementById('preferencesJson');
        const ext = document.getElementById('extJson');
        const adv = document.getElementById('advJson');

        prefs.addEventListener('input', () => { state.preferences_json = prefs.value; renderPreview(); });
        ext.addEventListener('input', () => { state.extension_settings_json = ext.value; renderPreview(); });
        adv.addEventListener('input', () => { state.advanced_json = adv.value; renderPreview(); });

        // init snapshot
        state.schema_version = schemaSel.value;
        state.name = form.name.value || "";
        state.description = form.description.value || "";
        state.doh = { Enabled: form.doh_enabled.checked, ProviderURL: form.doh_provider_url.value, Locked: form.doh_locked.checked };
    }

    document.addEventListener('DOMContentLoaded', async () => {
        attachFormHandlers();
        await loadBooleanFlags(state.schema_version);
        renderPreview();
    });
</script>
{% endblock %}