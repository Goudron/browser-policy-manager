<!doctype html>
<html lang="{{ request.state.lang or 'en' }}">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ t('ui.import.title', 'Import policies.json') }} · {{ t('ui.header.title', 'Browser Policy Manager') }}
    </title>
    <style>
        :root {
            --fg: #222;
            --muted: #666;
            --brand: #0b6cff;
            --bg: #fff;
            --panel: #f8f9fb;
            --border: #e6e8ef;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
            margin: 2rem;
            line-height: 1.6;
            color: var(--fg);
            background: var(--bg);
        }

        header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        nav a {
            text-decoration: none;
            color: var(--brand);
            margin-right: .5rem;
        }

        nav a.active {
            font-weight: 600;
            color: var(--fg);
        }

        a.btn,
        button.btn {
            border: 1px solid var(--brand);
            background: var(--brand);
            color: #fff;
            padding: .5rem .9rem;
            border-radius: 10px;
            text-decoration: none;
            display: inline-block;
        }

        a.link {
            color: var(--brand);
            text-decoration: none;
        }

        section.card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
        }

        h1 {
            margin: 0;
            font-size: 1.25rem;
        }

        h2 {
            margin: 0 0 .75rem;
            font-size: 1.15rem;
        }

        p.muted {
            color: var(--muted);
            margin-top: .25rem;
        }

        .row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="file"] {
            display: inline-block;
            padding: .45rem .6rem;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        button {
            border: 1px solid var(--brand);
            background: var(--brand);
            color: #fff;
            padding: .5rem .9rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        button[disabled] {
            opacity: .6;
            cursor: not-allowed;
        }

        .result {
            display: grid;
            gap: .75rem;
        }

        .result pre {
            margin: 0;
            padding: .75rem;
            background: #111;
            color: #eee;
            border-radius: 8px;
            overflow: auto;
            max-height: 50vh;
            font-size: .875rem;
        }

        .badge {
            display: inline-block;
            padding: .15rem .5rem;
            border-radius: 999px;
            background: #111;
            color: #fff;
            font-size: .75rem;
            margin-left: .35rem;
            vertical-align: middle;
        }

        .warn {
            background: #d14;
        }

        .ok {
            background: #2b8a3e;
        }

        .err {
            background: #b30021;
        }

        .hidden {
            display: none;
        }

        footer {
            margin-top: 2rem;
            color: var(--muted);
            font-size: .95em;
        }

        code {
            background: #f4f4f4;
            padding: .15rem .35rem;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <a href="/" class="link">← {{ t('ui.back.home', 'Back to Home') }}</a>
            <h1>{{ t('ui.import.title', 'Import policies.json') }}</h1>
            <p class="muted">
                {{ t('ui.import.hint', 'Use the endpoint') }}
                <code>POST /api/import-policies</code>
                {{ t('ui.import.cont', 'to import and preview your Firefox policy set.') }}
            </p>
        </div>
        <nav>
            {% set lang = request.state.lang or 'en' %}
            <a href="?lang=en" class="{{ 'active' if lang == 'en' else '' }}">EN</a>
            <a href="?lang=ru" class="{{ 'active' if lang == 'ru' else '' }}">RU</a>
        </nav>
    </header>

    <section class="card" id="import-card">
        <h2>{{ t('ui.import.title', 'Import policies.json') }}</h2>
        <form id="import-form" class="row">
            <input id="file-input" type="file" accept="application/json,.json"
                aria-label="{{ t('ui.import.choose', 'Choose policies.json') }}" />
            <button id="btn-import" type="submit">{{ t('ui.import.button', 'Import') }}</button>
            <span id="status" class="badge hidden"></span>
        </form>
    </section>

    <section class="card" id="result-card" aria-live="polite">
        <div class="row" style="justify-content: space-between;">
            <h2 style="margin:0;">{{ t('ui.import.result', 'Import result') }}</h2>
            <div>
                <span id="badge-warnings" class="badge warn hidden"></span>
                <span id="badge-ok" class="badge ok hidden">{{ t('ui.import.ok', 'OK') }}</span>
                <span id="badge-error" class="badge err hidden">{{ t('ui.import.error', 'Error') }}</span>
            </div>
        </div>

        <div class="result" style="margin-top: .5rem;">
            <div id="warnings-block" class="hidden">
                <strong>{{ t('ui.import.warnings', 'Warnings') }}:</strong>
                <pre id="warnings-pre"></pre>
            </div>
            <div id="policies-block" class="hidden">
                <strong>{{ t('ui.import.policies', 'Normalized policies') }}:</strong>
                <pre id="policies-pre"></pre>
            </div>
        </div>
    </section>

    <footer>
        <p>{{ t('ui.footer.note', 'This is a minimal placeholder template for Browser Policy Manager.') }}</p>
    </footer>

    <script>
        (function () {
            const form = document.getElementById('import-form');
            const fileInput = document.getElementById('file-input');
            const btn = document.getElementById('btn-import');
            const status = document.getElementById('status');

            const badgeWarn = document.getElementById('badge-warnings');
            const badgeOk = document.getElementById('badge-ok');
            const badgeErr = document.getElementById('badge-error');

            const blockWarnings = document.getElementById('warnings-block');
            const preWarnings = document.getElementById('warnings-pre');
            const blockPolicies = document.getElementById('policies-block');
            const prePolicies = document.getElementById('policies-pre');

            function setHidden(el, hidden) { if (!el) return; el.classList.toggle('hidden', hidden); }
            function setBadge(el, text) { if (!el) return; el.textContent = text; setHidden(el, !text); }
            function resetUI() {
                setHidden(blockWarnings, true); setHidden(blockPolicies, true);
                setBadge(badgeWarn, ''); setHidden(badgeOk, true); setHidden(badgeErr, true);
                status.textContent = ''; setHidden(status, true);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault(); resetUI();
                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    status.textContent = '{{ t("ui.import.no_file", "No file selected") }}';
                    setHidden(status, false);
                    return;
                }
                btn.disabled = true;
                status.textContent = '{{ t("ui.import.uploading", "Uploading...") }}';
                setHidden(status, false);
                try {
                    const fd = new FormData();
                    fd.append('file', file, file.name);
                    const res = await fetch('/api/import-policies', { method: 'POST', body: fd });
                    if (!res.ok) {
                        setHidden(badgeErr, false);
                        status.textContent = '{{ t("ui.import.failed", "Import failed") }}';
                        setHidden(status, false);
                        try {
                            const err = await res.json();
                            preWarnings.textContent = JSON.stringify(err, null, 2);
                            setHidden(blockWarnings, false);
                        } catch (_) { }
                        return;
                    }
                    const data = await res.json();
                    const warnings = Array.isArray(data.warnings) ? data.warnings : [];
                    const policies = data.policies || {};
                    if (warnings.length) {
                        preWarnings.textContent = JSON.stringify(warnings, null, 2);
                        setHidden(blockWarnings, false);
                        setBadge(badgeWarn, warnings.length + ' warning' + (warnings.length > 1 ? 's' : ''));
                    } else {
                        setHidden(badgeOk, false);
                    }
                    prePolicies.textContent = JSON.stringify(policies, null, 2);
                    setHidden(blockPolicies, false);
                    status.textContent = '{{ t("ui.import.done", "Done") }}';
                    setHidden(status, false);
                } catch (err) {
                    setHidden(badgeErr, false);
                    status.textContent = '{{ t("ui.import.error", "Error") }}';
                    setHidden(status, false);
                    preWarnings.textContent = String(err);
                    setHidden(blockWarnings, false);
                } finally {
                    btn.disabled = false;
                }
            });
        })();
    </script>
</body>

</html>