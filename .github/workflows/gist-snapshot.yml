name: gist-snapshot

on:
    push:
        branches: ["dev"]
    workflow_dispatch:

permissions:
    contents: read

jobs:
    test-and-publish-gist:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Install project (dev)
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[dev]
                  # ensure requests for gist script
                  pip install requests

            - name: Ruff + mypy (do not fail job)
              continue-on-error: true
              run: |
                  ruff check .
                  mypy app || true

            - name: Run tests with coverage (do not fail job)
              continue-on-error: true
              run: |
                  set -o pipefail
                  pytest -q --maxfail=1 --disable-warnings \
                    --cov=app --cov-report=term-missing:skip-covered \
                    --cov-report=xml \
                    | tee pytest-report.txt

            - name: Publish snapshot to Secret Gist
              env:
                  GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
              run: |
                  python tools/publish_to_gist.py

            - name: Upload gist info artifact
              uses: actions/upload-artifact@v4
              with:
                  name: gist-info
                  path: |
                      gist_url.txt
                      coverage.xml
                      pytest-report.txt
